<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NINDEX</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    :root {
      --bg: #1e1e2f;
      --surface: #2b2c3f;
      --surface-hover: #3a3b4f;
      --text-primary: #f0f0f5;
      --text-secondary: #a0a0b1;
      --accent: #4e9af1;
      --accent-hover: #6ab3ff;
      --danger: #f14e4e;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: var(--bg); color: var(--text-primary); font-family: 'Inter', sans-serif; min-height: 100vh; display: flex; flex-direction: column; }
    header { background: var(--surface); display: flex; align-items: center; justify-content: space-between; padding: 1rem; }
    .logo { display: flex; align-items: center; gap: .5rem; font-weight: 600; }
    .logo svg { width: 24px; height: 24px; fill: var(--accent); }
    .actions { display: flex; align-items: center; gap: 1rem; }
    .actions button, .actions img { background: transparent; border: none; cursor: pointer; color: var(--text-secondary); }
    .actions img { width: 32px; height: 32px; border-radius: 50%; }
    #app { flex: 1; display: flex; flex-direction: column; }
    .view { flex: 1; display: none; flex-direction: column; padding: 2rem; }
    .active { display: flex; } /* This makes the active view visible */
    .center { align-items: center; justify-content: center; text-align: center; }
    h1 { font-size: 2rem; margin-bottom: 1rem; }
    h2 .ninja-count { font-size: 0.7em; font-weight: 400; color: var(--text-secondary); }
    p { color: var(--text-secondary); margin-bottom: 2rem; }
    .btn { font-weight: 600; padding: .5rem 1rem; border: none; border-radius: .5rem; cursor: pointer; transition: background .2s; margin-left: 0.5rem }
    .btn:first-child { margin-left: 0; } 
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-primary:hover { background: var(--accent-hover); }
    .btn-secondary { background: var(--surface-hover); color: var(--text-primary); }
    .btn-secondary:hover { background: var(--surface); }
    .browse-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .browse-header > div { display: flex; align-items: center; } 
    .filter-section { margin-bottom: 1rem; }
    .filter-section h3 { margin-bottom: .5rem; font-size: .9rem; color: var(--text-secondary); }
    .filters { display: flex; flex-wrap: wrap; gap: .5rem; }
    .tag { padding: .25rem .5rem; border: 1px solid var(--text-secondary); border-radius: 999px; cursor: pointer; font-size: .85rem; background: var(--surface); color: var(--text-primary); }
    .tag.selected { background: var(--accent); color: #fff; }
    .ninja-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px,1fr)); gap: 1rem; }
    .ninja-card { background: var(--surface); padding: 1rem; border-radius: .5rem; position: relative; transition: transform 0.1s ease-out, border-top 0.1s ease-out; }
    .ninja-card[draggable="true"] { cursor: grab; }
    .ninja-card.dragging { opacity: 0.4; border: 2px dashed var(--accent); cursor: grabbing; }
    .ninja-card.drag-over-target { border-top: 3px solid var(--accent-hover); transform: translateY(-2px); }
    .card-actions { position: absolute; top: .5rem; right: .5rem; display: flex; gap: .5rem; }
    .card-actions button { background: transparent; border: none; cursor: pointer; color: var(--text-secondary); }
    .ninja-tags { display: flex; flex-wrap: wrap; gap: .25rem; margin-top: .5rem; }
    .form-section { margin-bottom: 1rem; }
    .form-section h3 { font-size: .9rem; margin-bottom: .5rem; color: var(--text-secondary); }
    input[type="text"] { width: 100%; padding: .5rem; border: 1px solid var(--text-secondary); border-radius: .5rem; background: var(--bg); color: var(--text-primary); margin-bottom: .5rem; }
    .drop-zone { border: 2px dashed var(--text-secondary); padding: 1rem; text-align: center; border-radius: .5rem; cursor: pointer; margin-bottom: 1rem; }
    .dragover { border-color: var(--accent); }
  </style>
</head>
<body>
  <header>
    <div class="logo"><svg viewBox="0 0 24 24"><path d="M12 2l8 8-8 8-8-8z"/></svg><span>NINDEX</span></div>
    <div class="actions">
      <!-- User profile/actions can go here if needed -->
    </div>
  </header>

  <div id="app">
    <!-- Welcome View -->
    <div id="welcome" class="view center active"> <!-- Starts active -->
      <div> <!-- Added a wrapper div for better centering if multiple elements -->
        <h1>Welcome to NINDEX</h1>
        <p>Add your first ninja to get started</p>
        <div>
          <button class="btn btn-primary" id="addBtn">Add Ninja</button>
          <button class="btn btn-secondary" id="browseBtn">Browse</button>
        </div>
      </div>
    </div>

    <!-- Add/Edit Ninja View -->
    <div id="addView" class="view">
      <!-- Content for adding/editing ninjas will be generated by JS -->
    </div>

    <!-- Browse Ninjas View -->
    <div id="browseView" class="view">
      <div class="browse-header">
        <h2>Your Ninjas <span id="ninjaCountDisplay" class="ninja-count">(Total: 0, Showing: 0)</span></h2>
        <div>
          <button class="btn btn-primary" id="addFromBrowse">Add Ninja</button>
          <button class="btn btn-secondary" id="clearAllFilters">Clear All Filters</button>
          <button class="btn btn-secondary" id="exportJsonBtn">Export JSON</button>          
          <input type="file" id="importJsonInput" accept=".json" style="display: none;">
          <button class="btn btn-secondary" id="importJsonBtn">Import JSON</button>
        </div>
      </div>
      <div id="filterContainer">
        <!-- Filters will be generated by JS -->
      </div>
      <div class="ninja-list" id="list">
        <!-- Ninja cards will be generated by JS -->
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      console.log("DOMContentLoaded event fired. Initializing script variables.");

      // Get core view elements and log their status immediately
      const welcome = document.getElementById('welcome');
      console.log("Element #welcome:", welcome);
      const addView = document.getElementById('addView');
      console.log("Element #addView:", addView);
      const browseView = document.getElementById('browseView');
      console.log("Element #browseView:", browseView);

      // Check if core views are missing, which is a critical failure
      if (!welcome || !addView || !browseView) {
          alert("Critical error: Core UI view elements (welcome, addView, or browseView) not found in the HTML. The application cannot start correctly. Please check the HTML structure and element IDs.");
          console.error("Critical error: One or more core view elements are missing. welcome:", welcome, "addView:", addView, "browseView:", browseView);
          document.body.innerHTML = '<h1 style="color:red; text-align:center; margin-top: 50px;">Application Critical Error: UI elements missing. Check console (F12).</h1>';
          return; 
      }

      const categories = {
        Village: ['Leaf','Sand','Mist','Leaf Rogue','Sand Rogue','Mist Rogue'],
        Masteries: ['Fire','Wind','Lightning','Earth','Water','Medical','Weapon','Taijutsu'],
        Corp: ['Leaf ANBU','Sand ANBU','Hunter-nin','Akatsuki','12 Guardians','Puppet Brigade','7 Swordsmen','LMPF','SMPF','MMPF','Leaf Med Corp','Sand Med Corp','Mist Med Corp'],
        Rank: ['Academy Student','Genin','Specialized Jonin','Chunin','Jonin','Kage','Hermit','Rogue Ninja']
      };
      const colors = {
        Leaf: '#225522', Sand: '#c2a76b', Mist: '#333366', Water: '#5588cc', 
        'Leaf Rogue':'#000000', 'Sand Rogue':'#000000', 'Mist Rogue':'#000000',
        Fire:'#cc3333', Wind:'#33aa33', Lightning:'#cccc33', Earth:'#996633', Medical:'#33cccc', Weapon:'#bbbbbb', Taijutsu:'#aa6633',
        default:'#000000'
      };

      let ninjas = []; 
      
      let defaultFilters = { search:'', Village:new Set(), Masteries:new Set(), Corp:new Set(), Rank:new Set() };
      let loadedFiltersState = null;
      try {
        const storedFilters = localStorage.getItem('nindexFiltersSettings');
        if (storedFilters) {
          loadedFiltersState = JSON.parse(storedFilters);
        }
      } catch (e) {
        console.warn("Could not parse nindexFiltersSettings from localStorage. Resetting.", e);
        localStorage.removeItem('nindexFiltersSettings');
      }
      
      let filters = { 
          ...defaultFilters,
          sort: (loadedFiltersState && loadedFiltersState.sort) ? loadedFiltersState.sort : 'new',
      };
      if (loadedFiltersState) {
          Object.keys(defaultFilters).forEach(key => {
              if(key !== 'search' && loadedFiltersState[key] && Array.isArray(loadedFiltersState[key])) {
                  filters[key] = new Set(loadedFiltersState[key]);
              } else if (key === 'search' && loadedFiltersState[key]) {
                  filters[key] = loadedFiltersState[key];
              }
          });
      }

      let currentEdit = null;
      let draggedNinjaId = null;

      const exportJsonBtn = document.getElementById('exportJsonBtn');
      const importJsonBtn = document.getElementById('importJsonBtn');
      const importJsonInput = document.getElementById('importJsonInput');
      const ninjaCountDisplay = document.getElementById('ninjaCountDisplay');
      let sortBtn;

      let db;
      const DB_NAME = 'NindexDB';
      const STORE_NAME = 'ninjasStore';
      const DB_VERSION = 1; 

      function initDB(successCallback, errorCallback) {
          console.log('Initializing DB...');
          if (!window.indexedDB) {
              console.error("IndexedDB not supported by this browser.");
              alert("Error: Your browser does not support IndexedDB, which is required for this application to function properly.");
              if (errorCallback) errorCallback(new Error("IndexedDB not supported"));
              return;
          }
          const request = indexedDB.open(DB_NAME, DB_VERSION);
          request.onupgradeneeded = (event) => {
              console.log('DB upgrade needed.');
              const dbInstance = event.target.result;
              if (!dbInstance.objectStoreNames.contains(STORE_NAME)) {
                  dbInstance.createObjectStore(STORE_NAME, { keyPath: 'id' });
                  console.log(`Object store '${STORE_NAME}' created.`);
              }
          };
          request.onsuccess = (event) => {
              db = event.target.result;
              console.log('Database initialized successfully.');
              db.onerror = (errEvent) => { 
                  console.error("Database error (on db object): ", errEvent.target.error || errEvent.target.errorCode);
              };
              if (successCallback) successCallback();
          };
          request.onerror = (event) => {
              console.error('Database initialization error (on request object):', event.target.error);
              alert('Error initializing database. NINDEX may not function correctly. Please ensure your browser supports IndexedDB and is not in private/incognito mode if issues persist. Error: ' + event.target.error.name);
              if (errorCallback) errorCallback(event.target.error);
          };
      }

      function loadNinjasFromDB(callback) {
          if (!db) {
              console.error('DB not initialized. Cannot load ninjas.');
              if (callback) callback([]);
              return;
          }
          try {
            const transaction = db.transaction(STORE_NAME, 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const getAllRequest = store.getAll();
            getAllRequest.onsuccess = () => {
                ninjas = getAllRequest.result || [];
                console.log(`Loaded ${ninjas.length} ninjas from DB.`);
                applySortToNinjasArray(); 
                if (callback) callback(ninjas);
            };
            getAllRequest.onerror = (event) => {
                console.error('Error fetching ninjas from DB:', event.target.error);
                alert('Error fetching ninjas from database: ' + event.target.error.name);
                if (callback) callback([]);
            };
          } catch (e) {
            console.error("Error creating transaction to load ninjas:", e);
            alert("Critical error accessing database store. Store might be missing or DB connection lost.");
            if (callback) callback([]);
          }
      }
      
      function applySortToNinjasArray() {
          if (!Array.isArray(ninjas)) ninjas = [];
          if (filters.sort === 'new') {
              ninjas.sort((a,b) => (b.id || 0) - (a.id || 0));
          } else if (filters.sort === 'alpha') {
              ninjas.sort((a,b) => (a.name || '').localeCompare(b.name || ''));
          }
      }

      async function saveAllNinjasToDB() {
          console.log(`Attempting to save ${ninjas.length} ninjas to DB in current order.`);
          return new Promise((resolve, reject) => {
              if (!db) { console.error('DB not initialized for saveAllNinjasToDB'); return reject(new Error('DB not initialized')); }
              const transaction = db.transaction(STORE_NAME, 'readwrite');
              const store = transaction.objectStore(STORE_NAME);
              const clearRequest = store.clear();
              clearRequest.onsuccess = () => {
                  console.log("Store cleared, proceeding to add ninjas.");
                  if (ninjas.length === 0) { resolve(); return; }
                  let errorOccurred = false;
                  ninjas.forEach((ninja, index) => {
                      if (errorOccurred) return; // Stop trying if an error already happened in this loop
                      const addRequest = store.add(ninja);
                      addRequest.onerror = (e) => { 
                        console.error(`Error adding ninja ${ninja.id} at index ${index} during bulk save:`, e.target.error); 
                        errorOccurred = true; 
                        // Don't reject here, let transaction.onerror handle it for the whole operation
                      };
                  });
              };
              clearRequest.onerror = (e) => { console.error('Error clearing store for bulk save:', e.target.error); reject(new Error('Failed to clear store: ' + e.target.error.name)); };
              transaction.oncomplete = () => { console.log('Transaction complete: Ninjas saved/reordered in DB.'); resolve(); };
              transaction.onerror = (e) => { console.error('Transaction error during bulk save:', e.target.error); reject(new Error('Transaction failed: ' + e.target.error.name)); };
          });
      }
      
      async function addNinjaToDB(ninja) {
          return new Promise((resolve, reject) => {
              if (!db) return reject(new Error('DB not initialized'));
              const transaction = db.transaction(STORE_NAME, 'readwrite');
              const store = transaction.objectStore(STORE_NAME);
              const request = store.add(ninja);
              request.onsuccess = () => { console.log(`Ninja ${ninja.id} add request successful.`); resolve(); };
              request.onerror = (event) => { console.error(`Error on add request for ninja ${ninja.id}:`, event.target.error); reject(event.target.error); };
          });
      }

      async function updateNinjaInDB(ninja) {
          return new Promise((resolve, reject) => {
              if (!db) return reject(new Error('DB not initialized'));
              const transaction = db.transaction(STORE_NAME, 'readwrite');
              const store = transaction.objectStore(STORE_NAME);
              const request = store.put(ninja); 
              request.onsuccess = () => { console.log(`Ninja ${ninja.id} update request successful.`); resolve(); };
              request.onerror = (event) => { console.error(`Error on put request for ninja ${ninja.id}:`, event.target.error); reject(event.target.error); };
          });
      }

      async function deleteNinjaFromDB(ninjaId) {
          return new Promise((resolve, reject) => {
              if (!db) return reject(new Error('DB not initialized'));
              const transaction = db.transaction(STORE_NAME, 'readwrite');
              const store = transaction.objectStore(STORE_NAME);
              const request = store.delete(ninjaId);
              request.onsuccess = () => { console.log(`Ninja ${ninjaId} delete request successful.`); resolve(); };
              request.onerror = (event) => { console.error(`Error on delete request for ninja ${ninjaId}:`, event.target.error); reject(event.target.error); };
          });
      }

      function toggleView(viewToActivate) {
        console.log('Toggling view to:', viewToActivate ? viewToActivate.id : 'undefined (viewToActivate is null/undefined)');
        [welcome, addView, browseView].forEach(v => { // These are checked at script start
          if (v) v.classList.remove('active');
        });
        if (viewToActivate) { 
          viewToActivate.classList.add('active');
        } else {
          console.error("toggleView called with null or undefined viewToActivate parameter.");
          if(welcome) welcome.classList.add('active'); // Fallback to welcome if it exists
        }
      }
      
      if(document.getElementById('addFromBrowse')) {
        document.getElementById('addFromBrowse').onclick = () => { if(!addView) {console.error("Add View is null!"); return;} toggleView(addView); showAddForm(); };
      }
      if(document.getElementById('clearAllFilters')) {
        document.getElementById('clearAllFilters').onclick = () => {
          filters.search = '';
          ['Village','Masteries','Corp','Rank'].forEach(c => filters[c].clear());
          saveFiltersState(); 
          showBrowse();
        };
      }

      if(exportJsonBtn) {
        exportJsonBtn.onclick = () => {
          const ninjasData = JSON.stringify(ninjas, null, 2); 
          const blob = new Blob([ninjasData], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = 'nindex_data.json';
          document.body.appendChild(a); a.click();
          document.body.removeChild(a); URL.revokeObjectURL(url);
        };
      }

      if(importJsonBtn && importJsonInput) {
        importJsonBtn.onclick = () => { importJsonInput.click(); };
        importJsonInput.onchange = async (event) => {
          const file = event.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = async (e) => {
              try {
                const importedData = JSON.parse(e.target.result);
                if (Array.isArray(importedData) && (importedData.length === 0 || importedData.every(item => typeof item === 'object' && item !== null && 'id' in item && 'name' in item))) {
                  if (!db) { alert('Database not ready for import. Please try again.'); return; }
                  const transaction = db.transaction(STORE_NAME, 'readwrite');
                  const store = transaction.objectStore(STORE_NAME);
                  const clearRequest = store.clear();
                  clearRequest.onerror = (errEvent) => { console.error('Failed to clear store for import:', errEvent.target.error); alert('Error clearing existing data: ' + errEvent.target.error.name); throw new Error('Failed to clear store.'); };
                  clearRequest.onsuccess = () => { importedData.forEach(item => { store.add(item); }); };
                  transaction.oncomplete = () => { ninjas = importedData; filters.sort = 'new'; applySortToNinjasArray(); saveFiltersState(); showBrowse(); alert('Ninjas imported successfully!'); };
                  transaction.onerror = (errEvent) => { console.error('Error during import transaction:', errEvent.target.error); alert('Error importing ninjas: ' + errEvent.target.error.name); };
                } else { alert('Invalid JSON file structure.'); }
              } catch (error) { alert('Error processing import file: ' + error.message); console.error("Import error:", error); }
              event.target.value = null; 
            };
            reader.onerror = () => { alert('Error reading file.'); event.target.value = null; };
            reader.readAsText(file);
          }
        };
      }

      function saveFiltersState() { 
          const filterStatesToSave = { sort: filters.sort, search: filters.search };
          ['Village','Masteries','Corp','Rank'].forEach(cat => { filterStatesToSave[cat] = Array.from(filters[cat]); });
          localStorage.setItem('nindexFiltersSettings', JSON.stringify(filterStatesToSave));
      }

      const sortStates = ['new', 'alpha', 'manual'];
      function updateSortButtonText() {
          if (!sortBtn) return;
          if (filters.sort === 'new') sortBtn.textContent = 'Sort: Recently Added';
          else if (filters.sort === 'alpha') sortBtn.textContent = 'Sort: A-Z';
          else if (filters.sort === 'manual') sortBtn.textContent = 'Sort: Custom';
          else { filters.sort = 'new'; sortBtn.textContent = 'Sort: Recently Added'; }
      }

      function showBrowse() {
        console.log("showBrowse called");
        if (!browseView) { console.error("browseView element is null, cannot show browse view."); return; }
        toggleView(browseView);
        const fc = document.getElementById('filterContainer'); 
        if (!fc) { console.error("filterContainer not found!"); return; }
        fc.innerHTML = '';
        const sSec = document.createElement('div'); sSec.className = 'filter-section';
        const input = document.createElement('input');
        input.type = 'text'; input.placeholder = 'Search...'; input.value = filters.search;
        input.oninput = e => { filters.search = e.target.value; saveFiltersState(); renderBrowse(); };
        if (!sortBtn) {
            sortBtn = document.createElement('button');
            sortBtn.className = 'btn btn-secondary';
            sortBtn.onclick = async () => { 
              let cIdx = sortStates.indexOf(filters.sort); cIdx = (cIdx + 1) % sortStates.length; filters.sort = sortStates[cIdx];
              applySortToNinjasArray(); 
              try { await saveAllNinjasToDB(); saveFiltersState(); updateSortButtonText(); renderBrowse(); } 
              catch (error) { console.error("Error saving sorted ninjas:", error); alert("Failed to save sorted ninjas: " + error.message); }
            };
        }
        updateSortButtonText(); sSec.append(input, sortBtn); fc.appendChild(sSec);
        Object.keys(categories).forEach(cat => {
          const sec = document.createElement('div'); sec.className = 'filter-section';
          const h3 = document.createElement('h3'); h3.textContent = cat; sec.appendChild(h3);
          const wrap = document.createElement('div'); wrap.className = 'filters';
          categories[cat].forEach(val => {
            const t = document.createElement('div'); t.className = 'tag'; t.textContent = val; styleTag(t, cat, val); 
            t.onclick = () => { if (filters[cat].has(val)) filters[cat].delete(val); else filters[cat].add(val); styleTag(t, cat, val); saveFiltersState(); renderBrowse(); };
            wrap.appendChild(t);
          });
          const clr = document.createElement('div'); clr.className = 'tag'; clr.textContent = 'Clear ' + cat;
          clr.onclick = () => { filters[cat].clear(); Array.from(wrap.children).forEach(el => { if(categories[cat].includes(el.textContent)) styleTag(el, cat, el.textContent); }); saveFiltersState(); renderBrowse(); };
          wrap.appendChild(clr); sec.appendChild(wrap); fc.appendChild(sec);
        });
        renderBrowse(); 
      }

      function renderBrowse() {
        console.log("renderBrowse called");
        const list = document.getElementById('list'); 
        if (!list) { console.error("ninja-list (id=list) not found!"); return; }
        list.innerHTML = '';
        let results = ninjas.filter(n => {
          const q = filters.search.toLowerCase();
          if (q && !((n.name||'').toLowerCase().includes(q) || (n.guild||'').toLowerCase().includes(q))) return false;
          return ['Village','Masteries','Corp','Rank'].every(cat => {
            if (!filters[cat] || !filters[cat].size) return true; 
            const val = n[cat] || (cat==='Masteries'?[]:'');
            if (cat === 'Masteries') return Array.isArray(val) ? [...filters[cat]].every(t => val.includes(t)) : false;
            return Array.isArray(val) ? [...filters[cat]].every(t => val.includes(t)) : filters[cat].has(val);
          });
        });
        if (filters.sort === 'alpha') { results.sort((a, b) => (a.name || '').localeCompare(b.name || '')); } 
        else if (filters.sort === 'new') { results.sort((a, b) => (b.id || Date.now()) - (a.id || Date.now())); }
        if(ninjaCountDisplay) ninjaCountDisplay.textContent = `(Total: ${ninjas.length}, Showing: ${results.length})`;
        if (results.length === 0 && ninjas.length > 0) list.innerHTML = '<p>No ninjas match your current filters.</p>';
        else if (ninjas.length === 0) list.innerHTML = '<p>No ninjas added yet. Click "Add Ninja" or import data.</p>';
        results.forEach(n => {
          const card = document.createElement('div'); card.className = 'ninja-card'; card.dataset.ninjaId = String(n.id); card.setAttribute('draggable', true); 
          card.addEventListener('dragstart', handleDragStart); card.addEventListener('dragenter', handleDragEnter); card.addEventListener('dragover', handleDragOver);
          card.addEventListener('dragleave', handleDragLeave); card.addEventListener('drop', handleDrop); card.addEventListener('dragend', handleDragEnd);
          const actions = document.createElement('div'); actions.className = 'card-actions';
          const eb = document.createElement('button'); eb.innerText = 'âœï¸'; eb.title = 'Edit Ninja'; eb.onclick = () => { showAddForm(ninjas.findIndex(x=>x.id===n.id)); };
          const dbBtn = document.createElement('button'); dbBtn.innerText = 'ðŸ—‘ï¸'; dbBtn.title = 'Delete Ninja';
          dbBtn.onclick = async () => { if (confirm(`Delete ${n.name||'this ninja'}?`)) { try { await deleteNinjaFromDB(n.id); ninjas = ninjas.filter(x=>x.id!==n.id); renderBrowse(); } catch (error) { console.error("Error deleting ninja:", error); alert("Failed to delete: " + error.message); }}};
          actions.append(eb, dbBtn); card.appendChild(actions);
          if (n.avatar) { const iC = document.createElement('div'); iC.style.cssText = 'width:100%;margin-bottom:8px;'; const i = document.createElement('img'); i.src = n.avatar; i.style.cssText = 'width:100%;height:auto;display:block;border-radius:4px;'; i.alt=n.name||'Ninja Avatar'; iC.appendChild(i); card.appendChild(iC); }
          const nameEl = document.createElement('h3'); nameEl.innerText = n.name||'Unnamed Ninja'; card.appendChild(nameEl);
          const guildEl = document.createElement('p'); guildEl.innerText = n.guild||'No Guild'; guildEl.style.cssText='color:var(--text-secondary);font-size:0.9em;'; card.appendChild(guildEl);
          const wrap = document.createElement('div'); wrap.className = 'ninja-tags';
          ['Village','Masteries','Corp','Rank'].forEach(cat => { const vals = Array.isArray(n[cat])?n[cat]:[n[cat]].filter(Boolean); vals.forEach(v => { if(!v)return; const t=document.createElement('div');t.className='tag selected'; const bg=(cat==='Corp'||cat==='Rank')?'#333333':(colors[v]||colors.default);t.style.background=bg;t.style.color='#fff';t.style.borderColor=bg;t.innerText=v;wrap.appendChild(t);});});
          card.appendChild(wrap); list.appendChild(card);
        });
      }

      function handleDragStart(event) { draggedNinjaId = event.target.dataset.ninjaId; event.dataTransfer.setData('text/plain', draggedNinjaId); event.target.classList.add('dragging'); }
      function handleDragEnter(event) { event.preventDefault(); const tc = event.target.closest('.ninja-card'); if (tc && tc.dataset.ninjaId !== draggedNinjaId) { tc.classList.add('drag-over-target'); }}
      function handleDragOver(event) { event.preventDefault(); }
      function handleDragLeave(event) { const tc = event.target.closest('.ninja-card'); if (tc) tc.classList.remove('drag-over-target'); }
      async function handleDrop(event) { 
          event.preventDefault(); const tc = event.target.closest('.ninja-card'); if (!tc) return; tc.classList.remove('drag-over-target'); const targetId = tc.dataset.ninjaId;
          if (!draggedNinjaId || draggedNinjaId === targetId) return;
          const dIdx = ninjas.findIndex(n => String(n.id) === String(draggedNinjaId)); const tIdx = ninjas.findIndex(n => String(n.id) === String(targetId));
          if (dIdx !== -1 && tIdx !== -1) { const [dItem] = ninjas.splice(dIdx, 1); ninjas.splice(tIdx, 0, dItem); filters.sort = 'manual'; 
              try { await saveAllNinjasToDB(); saveFiltersState(); if(sortBtn) updateSortButtonText(); renderBrowse(); } 
              catch (error) { console.error("Error saving drag/drop order:", error); alert("Failed to save order: " + error.message); }}
      }
      function handleDragEnd(event) { event.target.classList.remove('dragging'); document.querySelectorAll('.ninja-card.drag-over-target').forEach(c => c.classList.remove('drag-over-target')); draggedNinjaId = null; }

      function showAddForm(idx = null) {
        console.log("showAddForm called, index:", idx);
        if (!addView) { console.error("addView element is null, cannot show add form."); return; }
        toggleView(addView); currentEdit = idx; 
        const ninja = (idx !== null && ninjas[idx]) ? ninjas[idx] : {};
        addView.innerHTML = ''; 
        const formWrapper = document.createElement('div'); formWrapper.style.cssText = 'max-width:600px;margin:0 auto;';
        const pageTitle = document.createElement('h1'); pageTitle.textContent = idx !== null ? `Edit ${ninja.name || 'Ninja'}` : 'Add New Ninja'; pageTitle.style.textAlign = 'center'; addView.appendChild(pageTitle);
        const form = document.createElement('div');
        const bi = document.createElement('div'); bi.className='form-section';
        bi.innerHTML = `<h3>Basic Info</h3><input type="text" id="inName" placeholder="Name (Required)" value="${ninja.name||''}" /><input type="text" id="inGuild" placeholder="Guild" value="${ninja.guild||''}" />`;
        form.appendChild(bi);
        const formFilters = { Village:new Set(), Masteries:new Set(), Corp:new Set(), Rank:new Set() };
        Object.keys(categories).forEach(cat => {
          const sec = document.createElement('div'); sec.className='form-section'; const h3 = document.createElement('h3'); h3.innerText = cat + (cat==='Masteries'?' (select up to 2)':' (select 1)'); sec.appendChild(h3);
          const wrap = document.createElement('div'); wrap.className='filters'; formFilters[cat].clear(); 
          if (ninja[cat]) { (Array.isArray(ninja[cat])?ninja[cat]:[ninja[cat]]).forEach(v => { if(categories[cat].includes(v))formFilters[cat].add(v)}); }
          categories[cat].forEach(val => {
            const t = document.createElement('div'); t.className='tag'; t.textContent = val; styleTag(t, cat, val, formFilters[cat].has(val)); 
            t.onclick = () => {
              if (cat==='Masteries') { if(formFilters[cat].has(val))formFilters[cat].delete(val); else if(formFilters[cat].size<2)formFilters[cat].add(val); else alert('Max 2 masteries.'); } 
              else { const cur = formFilters[cat].has(val); formFilters[cat].clear(); if(!cur)formFilters[cat].add(val); }
              Array.from(wrap.children).forEach(el => { if(categories[cat].includes(el.textContent)) styleTag(el,cat,el.textContent,formFilters[cat].has(el.textContent));});
            }; wrap.appendChild(t);
          }); sec.appendChild(wrap); form.appendChild(sec);
        });
        const avatarSec = document.createElement('div'); avatarSec.className='form-section'; avatarSec.innerHTML='<h3>Avatar</h3>';
        const dz = document.createElement('div'); dz.className='drop-zone'; dz.innerText='Drag & Drop image or click (max 2MB)'; const inp = document.createElement('input'); inp.type='file';inp.accept='image/*';inp.style.display='none';
        let avatar = ninja.avatar||''; function upd(){dz.innerText=avatar?'Image selected. Click to change.':'Drag & Drop image or click (max 2MB)';}
        ['dragenter','dragover'].forEach(e=>dz.addEventListener(e,ev=>{ev.preventDefault();dz.classList.add('dragover');}));
        ['dragleave','drop'].forEach(e=>dz.addEventListener(e,ev=>{ev.preventDefault();dz.classList.remove('dragover');}));
        dz.addEventListener('drop',e=>loadFile(e.dataTransfer.files[0])); dz.addEventListener('click',()=>inp.click()); inp.addEventListener('change',()=>loadFile(inp.files[0]));
        function loadFile(f){if(!f)return;if(f.size > 2*1024*1024){alert('File is too large. Max 2MB.');inp.value='';return;} const r=new FileReader();r.onload=()=>{avatar=r.result;upd();};r.readAsDataURL(f);}
        upd(); avatarSec.appendChild(dz); avatarSec.appendChild(inp); form.appendChild(avatarSec);
        const btns = document.createElement('div'); btns.style.cssText='display:flex;gap:1rem;margin-top:2rem;'; 
        const saveBtn = document.createElement('button'); saveBtn.className='btn btn-primary'; saveBtn.innerText='Save Ninja';
        const cancelBtn = document.createElement('button'); cancelBtn.className='btn btn-secondary'; cancelBtn.innerText='Cancel'; 
        cancelBtn.onclick = ()=>{Object.keys(formFilters).forEach(c=>formFilters[c].clear()); if(!browseView){console.error("Browse View is null!"); return;} toggleView(browseView);showBrowse();};
        btns.append(saveBtn, cancelBtn); form.appendChild(btns); formWrapper.appendChild(form); addView.appendChild(formWrapper);
        saveBtn.onclick = async () => { 
          const nameIn = document.getElementById('inName'); if(!nameIn){console.error("Name input not found");return;} const name=nameIn.value.trim(); if(!name){alert('Name required.');nameIn.focus();return;}
          const guildIn = document.getElementById('inGuild'); const guild=guildIn?guildIn.value.trim():''; const newId=ninja.id||Date.now();
          const obj = { id:newId,name,guild,Village:[...formFilters.Village][0]||'',Masteries:[...formFilters.Masteries],Corp:[...formFilters.Corp][0]||'',Rank:[...formFilters.Rank][0]||'',avatar};
          try {
              if(currentEdit!==null && ninjas[currentEdit]) { ninjas[currentEdit]=obj; await updateNinjaInDB(obj); } 
              else { ninjas.push(obj); await addNinjaToDB(obj); if(filters.sort!=='manual'||ninjas.length<=1)filters.sort='new';}
              applySortToNinjasArray(); await saveAllNinjasToDB(); saveFiltersState(); 
              Object.keys(formFilters).forEach(cat=>formFilters[cat].clear()); 
              if(!browseView){console.error("Browse View is null!"); return;}
              toggleView(browseView); showBrowse(); 
          } catch (error) { console.error("Error saving ninja:",error);alert("Save failed: "+(error.message||error.name||"Unknown")+". Check console.");}
        };
      }

      function styleTag(el,cat,val,isSelected){const sel=typeof isSelected==='boolean'?isSelected:(filters[cat]?filters[cat].has(val):false);let bg;if(cat==='Corp'||cat==='Rank')bg=sel?'#333333':'var(--surface)';else bg=sel?(colors[val]||colors.default):'var(--surface)';el.style.background=bg;el.style.color=sel?'#fff':'var(--text-primary)';el.style.borderColor=sel?(cat==='Corp'||cat==='Rank'?'#555555':bg):'var(--text-secondary)';el.classList.toggle('selected',sel);}
      
      function initializeApp() {
        console.log("initializeApp: Setting up welcome screen button handlers...");
        const addBtnWelcome = document.getElementById('addBtn');
        const browseBtnWelcome = document.getElementById('browseBtn');

        if (addBtnWelcome) {
            addBtnWelcome.onclick = () => { 
                console.log("Add Ninja (welcome) clicked");
                if (!addView) { console.error("addView is null, cannot switch to add form."); return; }
                toggleView(addView); 
                showAddForm(); 
            };
        } else { 
            console.error("#addBtn (welcome screen) not found. Clicks won't work.");
        }

        if (browseBtnWelcome) {
            browseBtnWelcome.onclick = () => { 
                console.log("Browse (welcome) clicked");
                if (!browseView) { console.error("browseView is null, cannot switch to browse."); return; }
                toggleView(browseView); 
                showBrowse(); 
            };
        } else { 
            console.error("#browseBtn (welcome screen) not found. Clicks won't work.");
        }

        console.log("initializeApp: Starting DB initialization...");
        initDB(() => { 
            console.log("initializeApp: DB initialized. Loading ninjas...");
            loadNinjasFromDB(() => { 
                console.log("initializeApp: Ninjas loaded. Current count:", ninjas.length);
                if (ninjas.length > 0 || filters.search || Object.values(filters).some(f => (f instanceof Set && f.size > 0))) { 
                    console.log("initializeApp: Showing browse view.");
                    if (!browseView) { console.error("Browse View is null! Cannot show browse view."); return;}
                    showBrowse(); // browseView is checked inside showBrowse
                } else {
                    console.log("initializeApp: Showing welcome view.");
                    if (!welcome) { console.error("Welcome view element is null, cannot show welcome view."); return;}
                    toggleView(welcome); 
                }
            });
        }, (dbError) => { 
            console.error("initializeApp: DB Initialization failed critically. Error:", dbError);
            if(welcome) { toggleView(welcome); }
            else { document.body.innerHTML = '<h1 style="color:red; text-align:center; margin-top: 50px;">Critical Failure: Cannot initialize UI. Check console.</h1>'; }
            const errorMsgElem = document.createElement('p');
            errorMsgElem.textContent = 'Critical database error. Application may not work. Refresh or check browser settings.';
            errorMsgElem.style.cssText = 'color:red; text-align:center; padding:1rem;';
            const appDiv = document.getElementById('app');
            if (welcome && welcome.classList.contains('active')) { welcome.insertBefore(errorMsgElem, welcome.firstChild); }
            else if(appDiv) { appDiv.insertBefore(errorMsgElem, appDiv.firstChild); }
        });
      }

      initializeApp(); 

    }); 
  </script>
</body>
</html>